name: hello-kube kaeunlee

on:
  push:
    branches:
      - main
  workflow_dispatch: 

jobs:
  deploy:
    name: hello-kube
    runs-on: ubuntu-latest 

# 깃헙 시크릿에서 가져오는 값들
    env:
      K8S_API_SERVER: ${{ secrets.K8S_API_SERVER }}
      K8S_CLUSTER_CA: ${{ secrets.K8S_CLUSTER_CA }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      K8S_NAMESPACE: default

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

# kubectl 설치
      - name: Install kubectl
        run: |
          sudo apt-get update
          sudo apt-get install -y kubectl
# 쿠버네티스 접속 설정
# github actions vm에 ~/.kube/config 파일을 생성해서 k8s api서버와 통신
- name: Configure Kubernetes access
  run: |
    mkdir -p $HOME/.kube
    echo "${K8S_CLUSTER_CA}" | base64 --decode > "$HOME/.kube/ca.crt"

    cat > "$HOME/.kube/config" <<EOF
apiVersion: v1
kind: Config
clusters:
- cluster:
    certificate-authority: "$HOME/.kube/ca.crt"
    server: ${K8S_API_SERVER}
  name: github-actions-cluster
contexts:
- context:
    cluster: github-actions-cluster
    user: github-actions
    namespace: ${K8S_NAMESPACE}
  name: github-actions-context
current-context: github-actions-context
users:
- name: github-actions
  user:
    token: ${GITHUB_TOKEN}
EOF

# 파드 실행
      - name: Launch hello Pod
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Pod
          metadata:
            name: hello
          spec:
            containers:
              - name: hello
                image: busybox
                command: ["sh", "-c", "echo Hello from GitHub Actions && sleep 3600"]
          EOF

