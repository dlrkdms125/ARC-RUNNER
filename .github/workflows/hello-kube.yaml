name: hello-kube

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      K8S_API_SERVER: ${{ secrets.K8S_API_SERVER }}
      K8S_CLUSTER_CA: ${{ secrets.K8S_CLUSTER_CA }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      K8S_NAMESPACE: default

    steps:
      # 저장소 체크아웃
      - name: Checkout repository
        uses: actions/checkout@v4

      # kubectl 설치
      - name: Install kubectl
        run: |
          sudo apt-get update
          sudo apt-get install -y kubectl

      # kubeconfig 생성 및 인증 설정
      - name: Configure Kubernetes access
        run: |
          mkdir -p $HOME/.kube
          echo "${K8S_CLUSTER_CA}" | base64 --decode > "$HOME/.kube/ca.crt"

          cat > "$HOME/.kube/config" <<EOF
apiVersion: v1
kind: Config
clusters:
- cluster:
    certificate-authority: "$HOME/.kube/ca.crt"
    server: ${K8S_API_SERVER}
  name: github-actions-cluster
contexts:
- context:
    cluster: github-actions-cluster
    user: github-actions
    namespace: ${K8S_NAMESPACE}
  name: github-actions-context
current-context: github-actions-context
users:
- name: github-actions
  user:
    token: ${GITHUB_TOKEN}
EOF

      # 연결 확인
      - name: Verify connection
        run: |
          kubectl cluster-info
          kubectl get nodes

      # Hello Pod 실행
      - name: Launch hello Pod
        run: |
          cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: hello
spec:
  containers:
  - name: hello
    image: busybox
    command: ["sh", "-c", "echo Hello from GitHub Actions && sleep 3600"]
EOF

